name: Deploy to Staging

# ìŠ¤í…Œì´ì§• ë°°í¬ ì‹¤í–‰ ì¡°ê±´
on:
  push: # ì½”ë“œ í‘¸ì‹œ ì‹œ
    branches: [develop] # develop ë¸Œëœì¹˜ë§Œ
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  deploy-staging:
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½
    environment: staging # GitHub Environment 'staging' ì‚¬ìš© (ìŠ¹ì¸/ë³´ì•ˆ ì„¤ì • ê°€ëŠ¥)

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4 # ìµœì‹  ì²´í¬ì•„ì›ƒ ì•¡ì…˜

      # 2. Java ê°œë°œ í™˜ê²½ ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin' # Eclipse Temurin JDK
          java-version: '17' # Java 17

      # 3. ë°°í¬ ì „ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì•ˆì „ì„± í™•ë³´)
      - name: Run tests before deployment
        run: |
          chmod +x gradlew
          ./gradlew test --no-daemon
        env:
          JWT_SECRET_KEY: test-jwt-secret-key-for-ci-pipeline-must-be-256-bits # í…ŒìŠ¤íŠ¸ìš© JWT í‚¤

      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker Image
        run: |
          docker build -t essay-backend:staging-${{ github.sha }} .
          docker tag essay-backend:staging-${{ github.sha }} essay-backend:staging-latest

      # 5. Docker ì´ë¯¸ì§€ë¥¼ íŒŒì¼ë¡œ ì €ì¥ (ì„œë²„ ì „ì†¡ìš©)
      - name: Save Docker Image
        run: docker save essay-backend:staging-latest | gzip > essay-backend-staging.tar.gz

      # 6. í•„ìš”í•œ íŒŒì¼ë“¤ì„ ìŠ¤í…Œì´ì§• ì„œë²„ë¡œ ë³µì‚¬
      - name: Copy files to staging server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: 22
          source: essay-backend-staging.tar.gz,docker-compose.yml,init.sql
          target: /tmp/essay-staging/

      # 7. ìŠ¤í…Œì´ì§• ì„œë²„ì— ë°°í¬ ì‹¤í–‰ (ìˆ˜ì •ë¨)
      - name: Deploy to staging server
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /tmp/essay-staging
            
            # Docker ê·¸ë£¹ì— ì‚¬ìš©ì ì¶”ê°€ (ê¶Œí•œ ë¬¸ì œ í•´ê²°)
            sudo usermod -aG docker $USER
            newgrp docker || true
            
            # Docker ì„œë¹„ìŠ¤ ì‹œì‘ í™•ì¸
            sudo systemctl start docker
            sudo systemctl enable docker
            
            # Docker ì†Œì¼“ ê¶Œí•œ ì„¤ì •
            sudo chmod 666 /var/run/docker.sock
            
            # ì´ë¯¸ì§€ ë¡œë“œ
            docker load < essay-backend-staging.tar.gz
            
            # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            export SPRING_PROFILES_ACTIVE=dev
            export DB_PASSWORD="${{ secrets.STAGING_DB_PASSWORD }}"
            export JWT_SECRET_KEY="${{ secrets.STAGING_JWT_SECRET }}"
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker-compose down --remove-orphans || true
            
            # PostgreSQL ë¨¼ì € ì‹œì‘
            docker-compose up -d postgres
            
            # PostgreSQL ì¤€ë¹„ ëŒ€ê¸°
            sleep 15
            
            # PostgreSQL ì—°ê²° í™•ì¸ (sudo ì—†ì´ ì‹œë„)
            for i in {1..10}; do
              if docker ps | grep -q postgres && docker exec essay-postgres pg_isready -U postgres; then
                echo "PostgreSQL is ready"
                break
              fi
              echo "Waiting for PostgreSQL... (attempt $i/10)"
              sleep 5
            done
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆ ì‹œì‘
            docker-compose up -d app
            
            # ì‹œìŠ¤í…œ ì •ë¦¬
            docker system prune -f || true
            rm -f essay-backend-staging.tar.gz

      # 8. ë°°í¬ í›„ í—¬ìŠ¤ì²´í¬ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
      - name: Health Check with retry
        run: |
          echo "Waiting for application to start..."
          sleep 30
          
          for i in {1..10}; do
            if curl -f -s ${{ secrets.STAGING_URL }}/api/health; then
              echo "âœ… Health check passed"
              exit 0
            fi
            echo "â³ Attempt $i/10 failed, retrying in 10 seconds..."
            sleep 10
          done
          
          echo "âŒ Health check failed after 10 attempts"
          exit 1

      # 9. ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ì²˜ë¦¬
      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            echo "ğŸ”„ Rolling back due to deployment failure..."
            cd /tmp/essay-staging
            docker-compose logs app --tail=50 || true
            docker-compose down || true

      # 10. ë°°í¬ ê²°ê³¼ ì•Œë¦¼
      - name: Notify deployment result
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ Staging deployment successful: ${{ github.sha }}"
          else
            echo "ğŸ’¥ Staging deployment failed: ${{ github.sha }}"
          fi
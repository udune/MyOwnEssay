name: Deploy to Staging

# 스테이징 배포 실행 조건
on:
  push: # 코드 푸시 시
    branches: [develop] # develop 브랜치만
  workflow_dispatch: # 수동 실행도 가능

jobs:
  deploy-staging:
    runs-on: ubuntu-latest # 최신 Ubuntu 환경
    environment: staging # GitHub Environment 'staging' 사용 (승인/보안 설정 가능)

    steps:
      # 1. 소스코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4 # 최신 체크아웃 액션

      # 2. Java 개발 환경 설정
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin' # Eclipse Temurin JDK
          java-version: '17' # Java 17

      # 3. 배포 전 테스트 실행 (안전성 확보)
      - name: Run tests before deployment
        run: |
          chmod +x gradlew
          ./gradlew test --no-daemon
        env:
          JWT_SECRET_KEY: test-jwt-secret-key-for-ci-pipeline-must-be-256-bits # 테스트용 JWT 키

      # 4. Docker 이미지 빌드
      - name: Build Docker Image
        run: |
          docker build -t essay-backend:staging-${{ github.sha }} .
          docker tag essay-backend:staging-${{ github.sha }} essay-backend:staging-latest

      # 5. Docker 이미지를 파일로 저장 (서버 전송용)
      - name: Save Docker Image
        run: docker save essay-backend:staging-latest | gzip > essay-backend-staging.tar.gz

      # 6. 필요한 파일들을 스테이징 서버로 복사
      - name: Copy files to staging server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: 22
          source: essay-backend-staging.tar.gz,docker-compose.yml,init.sql
          target: /tmp/essay-staging/

      # 7. 스테이징 서버에 배포 실행
      - name: Deploy to staging server
        uses: appleboy/ssh-action@v0.1.6 # SSH 명령 실행 액션
        with:
          host: ${{ secrets.STAGING_HOST }} # 스테이징 서버 IP
          username: ${{ secrets.STAGING_USER }} # SSH 사용자명
          key: ${{ secrets.STAGING_SSH_KEY }} # SSH 개인키
          script: | # 서버에서 실행할 스크립트
            cd /tmp/essay-staging
            
            docker load < essay-backend-staging.tar.gz
            
            export SPRING_PROFILES_ACTIVE=dev
            export DB_PASSWORD="${{ secrets.STAGING_DB_PASSWORD }}"
            export JWT_SECRET_KEY="${{ secrets.STAGING_JWT_SECRET }}"
            
            docker-compose down --remove-orphans || true
            
            docker-compose up -d postgres
            
            sleep 15
            until docker exec essay-postgres pg_isready -U postgres; do
              echo "Waiting for PostgreSQL..."
              sleep 5
            done
            
            docker-compose up -d app
            
            docker system prune -f
            rm -f essay-backend-staging.tar.gz

      # 8. 배포 후 헬스체크 (재시도 로직 포함)
      - name: Health Check with retry
        run: |
          echo "Waiting for application to start..."
          sleep 30
          
          for i in {1..10}; do
            if curl -f -s ${{ secrets.STAGING_URL }}/api/health; then
              echo "✅ Health check passed"
              exit 0
            fi
            echo "⏳ Attempt $i/10 failed, retrying in 10 seconds..."
            sleep 10
          done
          
          echo "❌ Health check failed after 10 attempts"
          exit 1

      # 9. 배포 실패 시 롤백 처리
      - name: Rollback on failure
        if: failure() # 이전 단계 중 하나라도 실패한 경우에만 실행
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            echo "🔄 Rolling back due to deployment failure..."
            cd /tmp/essay-staging
            docker-compose logs app --tail=50
            docker-compose down || true

      # 10. 배포 결과 알림
      - name: Notify deployment result
        if: always() # 성공/실패 관계없이 항상 실행
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "🎉 Staging deployment successful: ${{ github.sha }}"
          else
            echo "💥 Staging deployment failed: ${{ github.sha }}"
          fi
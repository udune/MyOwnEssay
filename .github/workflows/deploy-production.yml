name: Deploy to Production

# í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤í–‰ ì¡°ê±´ (ë§¤ìš° ì‹ ì¤‘)
on:
  push: # ì½”ë“œ í‘¸ì‹œ ì‹œ
    branches: [main] # main ë¸Œëœì¹˜ë§Œ (í”„ë¡œë•ì…˜ ë¸Œëœì¹˜)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ (ê¸´ê¸‰ ë°°í¬ìš©)

jobs:
  deploy-production:
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½
    environment: production # GitHub Environment 'production' ì‚¬ìš© (ìŠ¹ì¸ í•„ìš”)

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4 # ìµœì‹  ì²´í¬ì•„ì›ƒ ì•¡ì…˜

      # 2. Java ê°œë°œ í™˜ê²½ ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin' # Eclipse Temurin JDK
          java-version: '17' # Java 17

      # 3. ë°°í¬ ì „ ì¢…í•© í…ŒìŠ¤íŠ¸ (í”„ë¡œë•ì…˜ì€ ë” ì—„ê²©)
      - name: Run comprehensive tests
        run: |
          chmod +x gradlew # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          ./gradlew clean test --no-daemon # í´ë¦° ë¹Œë“œ + ì „ì²´ í…ŒìŠ¤íŠ¸
        env:
          JWT_SECRET_KEY: test-jwt-secret-key-for-ci-pipeline-must-be-256-bits # í…ŒìŠ¤íŠ¸ìš© JWT í‚¤

      # 4. í”„ë¡œë•ì…˜ìš© Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker Image
        run: |
          # ì»¤ë°‹ í•´ì‹œë¥¼ í¬í•¨í•œ í”„ë¡œë•ì…˜ íƒœê·¸
          docker build -t essay-backend:prod-${{ github.sha }} .
          # í”„ë¡œë•ì…˜ latest íƒœê·¸
          docker tag essay-backend:prod-${{ github.sha }} essay-backend:production-latest

      # 5. Docker ì´ë¯¸ì§€ë¥¼ ì••ì¶• íŒŒì¼ë¡œ ì €ì¥
      - name: Save Docker Image
        run: docker save essay-backend:production-latest | gzip > essay-backend-production.tar.gz

      # 6. í”„ë¡œë•ì…˜ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
      - name: Create production deployment script
        run: |
          cat > deploy-production.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "ğŸš€ === PRODUCTION DEPLOYMENT STARTED ==="
          
          # í™˜ê²½ë³€ìˆ˜ ê²€ì¦
          if [ -z "$DB_PASSWORD" ] || [ -z "$JWT_SECRET_KEY" ]; then
            echo "âŒ ERROR: Required environment variables not set!"
            exit 1
          fi
          
          echo "âœ… Environment variables validated"
          echo "DB_PASSWORD length: ${#DB_PASSWORD}"
          echo "JWT_SECRET_KEY length: ${#JWT_SECRET_KEY}"
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ í™•ì¸ ë° ë°±ì—… ì¤€ë¹„
          OLD_CONTAINER=$(docker ps -q -f name=essay-backend) # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ID ì €ì¥
          
          if [ -n "$OLD_CONTAINER" ]; then
            echo "ğŸ“¦ Found existing container: $OLD_CONTAINER"
          
            # ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ìƒì„± (ë°ì´í„° ë³´í˜¸)
            echo "ğŸ—„ï¸ Creating database backup..."
            mkdir -p /backup/essay
            BACKUP_FILE="/backup/essay/essay_db_$(date +'%Y%m%d_%H%M%S').sql"
          
            # ë°±ì—… ì‹¤í–‰ (ì‹¤íŒ¨í•´ë„ ë°°í¬ ê³„ì†)
            timeout 60 docker exec essay-backend sh -c "PGPASSWORD='$DB_PASSWORD' pg_dump -h 34.64.150.171 -U postgres -d myownessay-db" > "$BACKUP_FILE" 2>/dev/null || \
            echo "âš ï¸  Database backup failed (connection issue or timeout)"
          
            if [ -f "$BACKUP_FILE" ] && [ -s "$BACKUP_FILE" ]; then
              echo "âœ… Backup created: $BACKUP_FILE"
            else
              echo "âš ï¸  Backup file empty or missing"
            fi
          
            # ì´ì „ ë°±ì—… ì •ë¦¬ (ìµœì‹  10ê°œë§Œ ë³´ê´€)
            cd /backup/essay
            ls -t essay_db_*.sql 2>/dev/null | tail -n +11 | xargs -r rm 2>/dev/null || true
            cd - > /dev/null
          fi
          
          # Docker ì´ë¯¸ì§€ ë¡œë“œ
          echo "ğŸ“¥ Loading new Docker image..."
          docker load < essay-backend-production.tar.gz
          
          # ë¬´ì¤‘ë‹¨ ë°°í¬: ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ë‹¤ë¥¸ í¬íŠ¸ì—ì„œ ì‹œì‘
          echo "ğŸ”„ Starting new production container on standby port..."
          docker run -d \
            --name essay-backend-new \
            -p 8081:8080 \
            -e SPRING_PROFILES_ACTIVE=prod \
            -e SPRING_DATASOURCE_URL=jdbc:postgresql://34.64.150.171:5432/myownessay-db \
            -e SPRING_DATASOURCE_USERNAME=postgres \
            -e SPRING_DATASOURCE_PASSWORD="$DB_PASSWORD" \
            -e JWT_SECRET="$JWT_SECRET_KEY" \
            -e JWT_EXPIRATION=86400000 \
            -e JWT_REFRESH_EXPIRATION=604800000 \
            --restart unless-stopped \
            essay-backend:production-latest
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° ë° í—¬ìŠ¤ì²´í¬
          echo "â³ Waiting for new container to be ready..."
          sleep 20
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬ (í¬íŠ¸ 8081ì—ì„œ)
          NEW_CONTAINER_READY=false
          for i in {1..15}; do
            if curl -f -s http://localhost:8081/api/health > /dev/null; then
              echo "âœ… New container health check passed (attempt $i)"
              NEW_CONTAINER_READY=true
              break
            fi
            echo "ğŸ”„ Health check attempt $i/15..."
            sleep 5
          done
          
          if [ "$NEW_CONTAINER_READY" = false ]; then
            echo "âŒ New container health check failed"
            echo "ğŸ“‹ New container logs:"
            docker logs essay-backend-new --tail=30
            docker stop essay-backend-new || true
            docker rm essay-backend-new || true
            exit 1
          fi
          
          # íŠ¸ë˜í”½ ì „í™˜: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ í›„ ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ë©”ì¸ í¬íŠ¸ë¡œ ì´ë™
          if [ -n "$OLD_CONTAINER" ]; then
            echo "ğŸ›‘ Gracefully stopping old container..."
            docker stop essay-backend || true
            docker rm essay-backend || true
            sleep 3
          fi
          
          # ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ë©”ì¸ í¬íŠ¸ë¡œ ë³€ê²½
          echo "ğŸ”„ Switching new container to main port..."
          docker stop essay-backend-new
          docker rm essay-backend-new
          
          # ìµœì¢… í”„ë¡œë•ì…˜ ì»¨í…Œì´ë„ˆ ì‹œì‘
          echo "ğŸš€ Starting final production container..."
          docker run -d \
            --name essay-backend \
            -p 8080:8080 \
            -e SPRING_PROFILES_ACTIVE=prod \
            -e SPRING_DATASOURCE_URL=jdbc:postgresql://34.64.150.171:5432/myownessay-db \
            -e SPRING_DATASOURCE_USERNAME=postgres \
            -e SPRING_DATASOURCE_PASSWORD="$DB_PASSWORD" \
            -e JWT_SECRET="$JWT_SECRET_KEY" \
            -e JWT_EXPIRATION=86400000 \
            -e JWT_REFRESH_EXPIRATION=604800000 \
            --restart unless-stopped \
            essay-backend:production-latest
          
          # ìµœì¢… í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ Final health check..."
          sleep 15
          FINAL_CHECK_PASSED=false
          for i in {1..10}; do
            if curl -f -s http://localhost:8080/api/health > /dev/null; then
              echo "ğŸ‰ Production deployment successful! (attempt $i)"
              FINAL_CHECK_PASSED=true
              break
            fi
            echo "â³ Final check attempt $i/10..."
            sleep 5
          done
          
          if [ "$FINAL_CHECK_PASSED" = false ]; then
            echo "âŒ Final health check failed"
            echo "ğŸ“‹ Production container logs:"
            docker logs essay-backend --tail=30
            exit 1
          fi
          
          # ì„±ê³µ ë¡œê·¸
          echo "ğŸ“Š Production status:"
          docker ps | grep essay-backend
          echo "ğŸ“‹ Recent logs:"
          docker logs essay-backend --tail=10
          
          # ì‹œìŠ¤í…œ ì •ë¦¬
          docker system prune -f # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ ì •ë¦¬
          rm -f essay-backend-production.tar.gz # ì „ì†¡ëœ ì´ë¯¸ì§€ íŒŒì¼ ì‚­ì œ
          
          echo "ğŸ‰ === PRODUCTION DEPLOYMENT COMPLETED ==="
          EOF
          
          chmod +x deploy-production.sh

      # 7. í”„ë¡œë•ì…˜ ì„œë²„ ë””ë ‰í† ë¦¬ ì •ë¦¬
      - name: Clean production directory
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            sudo rm -rf /tmp/essay-production
            mkdir -p /tmp/essay-production
            sudo chown -R $USER:$USER /tmp/essay-production

      # 8. í•„ìš”í•œ íŒŒì¼ë“¤ì„ í”„ë¡œë•ì…˜ ì„œë²„ë¡œ ë³µì‚¬
      - name: Copy files to production server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PRODUCTION_HOST }} # í”„ë¡œë•ì…˜ ì„œë²„ IP (34.47.123.3)
          username: ${{ secrets.PRODUCTION_USER }} # SSH ì‚¬ìš©ìëª…
          key: ${{ secrets.PRODUCTION_SSH_KEY }} # SSH ê°œì¸í‚¤
          port: 22
          # ì „ì†¡ íŒŒì¼: Docker ì´ë¯¸ì§€ + ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
          source: essay-backend-production.tar.gz,deploy-production.sh
          target: /tmp/essay-production/
          overwrite: true

      # 9. ë¬´ì¤‘ë‹¨ í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤í–‰
      - name: Execute production deployment
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /tmp/essay-production
            
            # Docker ê¶Œí•œ ì„¤ì •
            sudo usermod -aG docker $USER || true
            sudo systemctl start docker || true
            sudo chmod 666 /var/run/docker.sock || true
            
            # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            export DB_PASSWORD="${{ secrets.PRODUCTION_DB_PASSWORD }}"
            export JWT_SECRET_KEY="${{ secrets.PRODUCTION_JWT_SECRET }}"
            
            # í”„ë¡œë•ì…˜ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            ./deploy-production.sh

      # 10. SSHë¥¼ í†µí•œ ì¢…í•©ì ì¸ í”„ë¡œë•ì…˜ í—¬ìŠ¤ì²´í¬
      - name: SSH Production Health Check
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            echo "ğŸ¥ === COMPREHENSIVE PRODUCTION HEALTH CHECK ==="
            
            # 1. ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            if ! docker ps | grep -q essay-backend; then
              echo "âŒ Production container not running"
              exit 1
            fi
            echo "âœ… Production container is running"
            
            # 2. í¬íŠ¸ ë¦¬ìŠ¤ë‹ í™•ì¸
            if ! ss -tlnp | grep -q :8080; then
              echo "âŒ Port 8080 not listening"
              exit 1
            fi
            echo "âœ… Port 8080 is listening"
            
            # 3. ê¸°ë³¸ í—¬ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
            echo "ğŸ” Testing health endpoint..."
            HEALTH_PASSED=false
            for i in {1..20}; do
              if curl -f -s http://localhost:8080/api/health > /dev/null; then
                echo "âœ… Health endpoint responding (attempt $i)"
                HEALTH_PASSED=true
                break
              fi
              if [ $i -lt 20 ]; then
                echo "â³ Health check attempt $i/20 - waiting 3 seconds..."
                sleep 3
              fi
            done
            
            if [ "$HEALTH_PASSED" = false ]; then
              echo "âŒ Health endpoint failed after 20 attempts"
              exit 1
            fi
            
            # 4. ì• í”Œë¦¬ì¼€ì´ì…˜ ì—”ë“œí¬ì¸íŠ¸ë“¤ ìƒì„¸ í…ŒìŠ¤íŠ¸
            echo "ğŸ” Testing application endpoints..."
            
            # í™ˆí˜ì´ì§€ í…ŒìŠ¤íŠ¸
            if curl -f -s http://localhost:8080/ | grep -q "MyOwnEssay"; then
              echo "âœ… Home page accessible and content verified"
            else
              echo "âŒ Home page test failed"
              exit 1
            fi
            
            # ì •ë³´ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
            if curl -f -s http://localhost:8080/api/info | grep -q "MyOwnEssay"; then
              echo "âœ… Info endpoint accessible and content verified"
            else
              echo "âŒ Info endpoint test failed"
              exit 1
            fi
            
            # 5. ìƒì„¸ ì‘ë‹µ ì •ë³´ ì¶œë ¥
            echo "ğŸ“Š Detailed health response:"
            curl -s http://localhost:8080/api/health
            echo ""
            
            # 6. ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ í™•ì¸
            echo "ğŸ“Š Container resource usage:"
            docker stats essay-backend --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}"
            
            # 7. ìµœê·¼ ë¡œê·¸ í™•ì¸
            echo "ğŸ“‹ Recent application logs:"
            docker logs essay-backend --tail=15
            
            echo "ğŸ‰ === ALL PRODUCTION HEALTH CHECKS PASSED ==="

      # 11. ë°°í¬ ì‹¤íŒ¨ ì‹œ ê¸´ê¸‰ ë¡¤ë°± ì²˜ë¦¬
      - name: Emergency rollback on failure
        if: failure() # ì´ì „ ë‹¨ê³„ ì¤‘ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            echo "ğŸš¨ === PRODUCTION DEPLOYMENT FAILED - EMERGENCY ROLLBACK ==="
            cd /tmp/essay-production
            
            # ì‹¤íŒ¨í•œ ì»¨í…Œì´ë„ˆë“¤ ì •ë¦¬
            echo "ğŸ§¹ Cleaning up failed containers..."
            docker stop essay-backend-new essay-backend || true
            docker rm essay-backend-new essay-backend || true
            
            # í˜„ì¬ ìƒíƒœ ë¡œê·¸
            echo "ğŸ“‹ System state at failure:"
            docker ps -a | grep essay || echo "No essay containers"
            echo "ğŸ“‹ Available Docker images:"
            docker images | grep essay || echo "No essay images"
            
            # ë°±ì—… ìƒíƒœ í™•ì¸
            echo "ğŸ’¾ Backup status:"
            LATEST_BACKUP=$(ls -t /backup/essay/essay_db_*.sql 2>/dev/null | head -n 1)
            if [ -n "$LATEST_BACKUP" ]; then
              echo "âœ… Latest backup available: $LATEST_BACKUP"
              echo "ğŸ“Š Backup size: $(du -h "$LATEST_BACKUP" | cut -f1)"
            else
              echo "âš ï¸  No backup files found"
            fi
            
            # ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ìƒíƒœ
            echo "ğŸ“Š System resources:"
            free -h
            df -h | grep -E "(Filesystem|/dev/)"
            
            echo "âŒ === ROLLBACK COMPLETED - MANUAL INTERVENTION REQUIRED ==="
            echo "ğŸ“ URGENT: Contact system administrator immediately"
            echo "ğŸ”§ Manual database restore may be necessary"

      # 12. ë°°í¬ ê²°ê³¼ ìµœì¢… ì•Œë¦¼
      - name: Production deployment notification
        if: always() # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        run: |
          # ë°°í¬ ê²°ê³¼ì— ë”°ë¥¸ ë©”ì‹œì§€ ì¶œë ¥
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ ğŸ‰ ğŸ‰ PRODUCTION DEPLOYMENT SUCCESSFUL! ğŸ‰ ğŸ‰ ğŸ‰"
            echo "ğŸ“ Version: ${{ github.sha }}"
            echo "ğŸŒ Production Server: ${{ secrets.PRODUCTION_HOST }}:8080"
            echo "â° Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "ğŸ”’ All security checks passed"
            echo "ğŸ’¾ Database backup created"
            echo "ğŸ¥ Health checks: ALL PASSED"
            echo "ğŸš€ Zero-downtime deployment completed"
            echo "==============================================="
          else
            echo "ğŸ’¥ ğŸ’¥ ğŸ’¥ PRODUCTION DEPLOYMENT FAILED! ğŸ’¥ ğŸ’¥ ğŸ’¥"
            echo "âš ï¸  ğŸš¨ URGENT: Manual intervention required ğŸš¨"
            echo "ğŸ“ Failed version: ${{ github.sha }}"
            echo "ğŸ”§ Check logs and contact system administrator"
            echo "ğŸ“ Emergency rollback initiated"
            echo "ğŸ’¾ Database backups preserved"
            echo "âš ï¸  PRODUCTION SERVICE MAY BE AFFECTED"
            echo "==============================================="
          fi

      # 13. ì„±ê³µ ì‹œ ì •ë¦¬ ì‘ì—…
      - name: Cleanup on success
        if: success()
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /tmp/essay-production
            rm -f essay-backend-production.tar.gz deploy-production.sh
            docker system prune -f
            echo "âœ… Production cleanup completed"
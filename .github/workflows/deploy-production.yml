name: Deploy to Production

# í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤í–‰ ì¡°ê±´ (ë§¤ìš° ì‹ ì¤‘)
on:
  push: # ì½”ë“œ í‘¸ì‹œ ì‹œ
    branches: [main] # main ë¸Œëœì¹˜ë§Œ (í”„ë¡œë•ì…˜ ë¸Œëœì¹˜)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ (ê¸´ê¸‰ ë°°í¬ìš©)

jobs:
  deploy-production:
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½
    environment: production # GitHub Environment 'production' ì‚¬ìš© (ìŠ¹ì¸ í•„ìš”)

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4 # ìµœì‹  ì²´í¬ì•„ì›ƒ ì•¡ì…˜

      # 2. Java ê°œë°œ í™˜ê²½ ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin' # Eclipse Temurin JDK
          java-version: '17' # Java 17

      # 3. ë°°í¬ ì „ ì¢…í•© í…ŒìŠ¤íŠ¸ (í”„ë¡œë•ì…˜ì€ ë” ì—„ê²©)
      - name: Run comprehensive tests
        run: |
          chmod +x gradlew # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          ./gradlew clean test --no-daemon # í´ë¦° ë¹Œë“œ + ì „ì²´ í…ŒìŠ¤íŠ¸
        env:
          JWT_SECRET_KEY: test-jwt-secret-key-for-ci-pipeline-must-be-256-bits # í…ŒìŠ¤íŠ¸ìš© JWT í‚¤

      # 4. í”„ë¡œë•ì…˜ìš© Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker Image
        run: |
          # ì»¤ë°‹ í•´ì‹œë¥¼ í¬í•¨í•œ í”„ë¡œë•ì…˜ íƒœê·¸
          docker build -t essay-backend:prod-${{ github.sha }} .
          # í”„ë¡œë•ì…˜ latest íƒœê·¸
          docker tag essay-backend:prod-${{ github.sha }} essay-backend:production-latest

      # 5. Docker ì´ë¯¸ì§€ë¥¼ ì••ì¶• íŒŒì¼ë¡œ ì €ì¥
      - name: Save Docker Image
        run: docker save essay-backend:production-latest | gzip > essay-backend-production.tar.gz

      # 6. í•„ìš”í•œ íŒŒì¼ë“¤ì„ í”„ë¡œë•ì…˜ ì„œë²„ë¡œ ë³µì‚¬
      - name: Copy files to production server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PRODUCTION_HOST }} # í”„ë¡œë•ì…˜ ì„œë²„ IP
          username: ${{ secrets.PRODUCTION_USER }} # SSH ì‚¬ìš©ìëª…
          key: ${{ secrets.PRODUCTION_SSH_KEY }} # SSH ê°œì¸í‚¤
          # ì „ì†¡ íŒŒì¼: Docker ì´ë¯¸ì§€ + ì„¤ì • íŒŒì¼ë“¤
          source: "essay-backend-production.tar.gz,docker-compose.yml,init.sql"
          target: "/tmp/essay-production/" # í”„ë¡œë•ì…˜ ì„œë²„ ì„ì‹œ ë””ë ‰í† ë¦¬

      # 7. ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ìƒì„± (ë°ì´í„° ë³´í˜¸)
      - name: Create database backup
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p /backup/essay
            
            # PostgreSQL ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
            if docker ps -q -f name=essay-postgres > /dev/null; then
              echo "ğŸ“¦ Creating database backup..." # ë°±ì—… ì‹œì‘ ë©”ì‹œì§€
              # íƒ€ì„ìŠ¤íƒ¬í”„ê°€ í¬í•¨ëœ ë°±ì—… íŒŒì¼ëª… ìƒì„±
              BACKUP_FILE="/backup/essay/essay_db_$(date +'%Y%m%d_%H%M%S').sql"
              # PostgreSQL ë¤í”„ ì‹¤í–‰
              docker exec essay-postgres pg_dump -U postgres essay_db > "$BACKUP_FILE"
              echo "âœ… Backup created: $BACKUP_FILE" # ë°±ì—… ì™„ë£Œ ë©”ì‹œì§€
            
              # ë°±ì—… íŒŒì¼ ê°œìˆ˜ ì œí•œ (ìµœì‹  10ê°œë§Œ ë³´ê´€)
              cd /backup/essay
              ls -t essay_db_*.sql | tail -n +11 | xargs -r rm # 11ë²ˆì§¸ë¶€í„° ì‚­ì œ
            else
              echo "â„¹ï¸  No existing database to backup" # ë°±ì—…í•  DBê°€ ì—†ëŠ” ê²½ìš°
            fi

      # 8. ë¬´ì¤‘ë‹¨ ë°°í¬ ì‹¤í–‰ (Zero-downtime deployment)
      - name: Deploy to production with zero-downtime
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /tmp/essay-production # ì‘ì—… ë””ë ‰í† ë¦¬ ì´ë™
            
            # ìƒˆë¡œìš´ Docker ì´ë¯¸ì§€ ë¡œë“œ
            echo "ğŸ”„ Loading new Docker image..." # ë¡œë”© ì‹œì‘ ë©”ì‹œì§€
            docker load < essay-backend-production.tar.gz
            
            # í”„ë¡œë•ì…˜ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            export SPRING_PROFILES_ACTIVE=prod # í”„ë¡œë•ì…˜ í”„ë¡œí•„
            export DB_PASSWORD="${{ secrets.PRODUCTION_DB_PASSWORD }}" # í”„ë¡œë•ì…˜ DB ë¹„ë°€ë²ˆí˜¸
            export JWT_SECRET_KEY="${{ secrets.PRODUCTION_JWT_SECRET }}" # í”„ë¡œë•ì…˜ JWT í‚¤
            
            # PostgreSQLì´ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ˆë©´ ì‹œì‘
            if ! docker ps -q -f name=essay-postgres > /dev/null; then
              echo "ğŸš€ Starting PostgreSQL..." # PostgreSQL ì‹œì‘ ë©”ì‹œì§€
              docker-compose up -d postgres
            
              # PostgreSQL ì¤€ë¹„ ëŒ€ê¸°
              echo "â³ Waiting for PostgreSQL to be ready..."
              sleep 15 # 15ì´ˆ ê¸°ë³¸ ëŒ€ê¸°
              # PostgreSQL ì¤€ë¹„ ìƒíƒœê¹Œì§€ ëŒ€ê¸°
              until docker exec essay-postgres pg_isready -U postgres; do
                echo "Waiting for PostgreSQL..." # ëŒ€ê¸° ë©”ì‹œì§€
                sleep 5
              done
            fi
            
            # ë¡¤ë§ ì—…ë°ì´íŠ¸: ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ í›„ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
            echo "ğŸ”„ Starting new application container..." # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ ë©”ì‹œì§€
            OLD_CONTAINER=$(docker ps -q -f name=essay-backend) # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ID ì €ì¥
            
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
            docker-compose up -d app
            
            # ìƒˆ ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            sleep 20
            NEW_CONTAINER=$(docker ps -q -f name=essay-backend) # ìƒˆ ì»¨í…Œì´ë„ˆ ID í™•ì¸
            
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ í™•ì¸
            if [ -n "$NEW_CONTAINER" ]; then
              echo "âœ… New container started successfully" # ì„±ê³µ ë©”ì‹œì§€
            
              # ê¸°ì¡´ ì»¨í…Œì´ë„ˆê°€ ìˆê³  ìƒˆ ì»¨í…Œì´ë„ˆì™€ ë‹¤ë¥´ë©´ ê¸°ì¡´ ê²ƒ ì¢…ë£Œ
              if [ -n "$OLD_CONTAINER" ] && [ "$OLD_CONTAINER" != "$NEW_CONTAINER" ]; then
                echo "ğŸ›‘ Stopping old container: $OLD_CONTAINER" # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ë©”ì‹œì§€
                docker stop "$OLD_CONTAINER" || true # ì¢…ë£Œ (ì‹¤íŒ¨í•´ë„ ê³„ì†)
                docker rm "$OLD_CONTAINER" || true # ì œê±° (ì‹¤íŒ¨í•´ë„ ê³„ì†)
              fi
            else
              echo "âŒ Failed to start new container" # ì‹¤íŒ¨ ë©”ì‹œì§€
              exit 1 # ë°°í¬ ì‹¤íŒ¨ ì¢…ë£Œ
            fi
            
            # ì‹œìŠ¤í…œ ì •ë¦¬
            docker system prune -f # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ ì •ë¦¬
            rm -f essay-backend-production.tar.gz # ì „ì†¡ëœ ì´ë¯¸ì§€ íŒŒì¼ ì‚­ì œ

      # 9. ì¢…í•©ì ì¸ í—¬ìŠ¤ì²´í¬ (í”„ë¡œë•ì…˜ìš© ì—„ê²©í•œ ê²€ì¦)
      - name: Comprehensive Health Check
        run: |
          echo "ğŸ¥ Starting comprehensive health checks..." # í—¬ìŠ¤ì²´í¬ ì‹œì‘
          sleep 30 # 30ì´ˆ ê¸°ë³¸ ëŒ€ê¸°
          
          # ê¸°ë³¸ í—¬ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ (15ë²ˆ ì‹œë„)
          for i in {1..15}; do
            if curl -f -s ${{ secrets.PRODUCTION_URL }}/api/health > /dev/null; then
              echo "âœ… Basic health check passed (attempt $i)" # ì„±ê³µ ë©”ì‹œì§€
              break # ì„±ê³µí•˜ë©´ ë£¨í”„ ì¢…ë£Œ
            fi
          
            if [ $i -eq 15 ]; then
              echo "âŒ Basic health check failed after 15 attempts" # 15ë²ˆ ëª¨ë‘ ì‹¤íŒ¨
              exit 1 # ì‹¤íŒ¨ ì¢…ë£Œ
            fi
          
            echo "â³ Health check attempt $i/15 failed, retrying in 10 seconds..." # ì¬ì‹œë„ ë©”ì‹œì§€
            sleep 10 # 10ì´ˆ ëŒ€ê¸°
          done
          
          # ì• í”Œë¦¬ì¼€ì´ì…˜ ì—”ë“œí¬ì¸íŠ¸ë“¤ í…ŒìŠ¤íŠ¸
          echo "ğŸ” Testing application endpoints..." # ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ ì‹œì‘
          
          # í™ˆí˜ì´ì§€ í…ŒìŠ¤íŠ¸
          if curl -f -s ${{ secrets.PRODUCTION_URL }}/ | grep -q "MyOwnEssay"; then
            echo "âœ… Home page accessible" # í™ˆí˜ì´ì§€ ì ‘ê·¼ ì„±ê³µ
          else
            echo "âŒ Home page test failed" # í™ˆí˜ì´ì§€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨
            exit 1
          fi
          
          # ì •ë³´ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
          if curl -f -s ${{ secrets.PRODUCTION_URL }}/api/info | grep -q "MyOwnEssay"; then
            echo "âœ… Info endpoint accessible" # ì •ë³´ ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ì„±ê³µ
          else
            echo "âŒ Info endpoint test failed" # ì •ë³´ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨
            exit 1
          fi
          
          echo "ğŸ‰ All health checks passed!" # ëª¨ë“  í—¬ìŠ¤ì²´í¬ í†µê³¼

      # 10. ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ì²˜ë¦¬ (ë°ì´í„° ë³µì› í¬í•¨)
      - name: Rollback on failure
        if: failure() # ì´ì „ ë‹¨ê³„ ì¤‘ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            echo "ğŸš¨ PRODUCTION DEPLOYMENT FAILED - Initiating rollback" # ë¡¤ë°± ì‹œì‘
            cd /tmp/essay-production
            
            # í˜„ì¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
            echo "ğŸ“‹ Current application logs:"
            docker-compose logs app --tail=100 # ìµœê·¼ 100ì¤„ ë¡œê·¸
            
            # ìµœì‹  ë°±ì—… íŒŒì¼ ì°¾ê¸°
            LATEST_BACKUP=$(ls -t /backup/essay/essay_db_*.sql 2>/dev/null | head -n 1)
            
            # ë°±ì—…ì´ ìˆìœ¼ë©´ ë°ì´í„°ë² ì´ìŠ¤ ë³µì›
            if [ -n "$LATEST_BACKUP" ]; then
              echo "ğŸ”„ Restoring database from backup: $LATEST_BACKUP" # ë³µì› ì‹œì‘
              # ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ ì‚­ì œ (ìˆìœ¼ë©´)
              docker exec essay-postgres dropdb -U postgres essay_db --if-exists
              # ìƒˆ ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
              docker exec essay-postgres createdb -U postgres essay_db
              # ë°±ì—…ì—ì„œ ë°ì´í„° ë³µì›
              docker exec -i essay-postgres psql -U postgres essay_db < "$LATEST_BACKUP"
            fi
            
            echo "âŒ Rollback completed. Manual intervention required." # ë¡¤ë°± ì™„ë£Œ

      # 11. ë°°í¬ ê²°ê³¼ ìµœì¢… ì•Œë¦¼
      - name: Notify deployment result
        if: always() # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        run: |
          # ë°°í¬ ê²°ê³¼ì— ë”°ë¥¸ ë©”ì‹œì§€ ì¶œë ¥
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ PRODUCTION deployment successful!" # í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ
            echo "ğŸ“ Version: ${{ github.sha }}" # ë°°í¬ëœ ì»¤ë°‹ í•´ì‹œ
            echo "ğŸŒ URL: ${{ secrets.PRODUCTION_URL }}" # í”„ë¡œë•ì…˜ URL
          else
            echo "ğŸ’¥ PRODUCTION deployment FAILED!" # í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨
            echo "âš ï¸  Manual intervention required" # ìˆ˜ë™ ê°œì… í•„ìš” ì•Œë¦¼
            echo "ğŸ“ Failed version: ${{ github.sha }}" # ì‹¤íŒ¨í•œ ì»¤ë°‹ í•´ì‹œ
          fi
name: Deploy to Staging

# ìŠ¤í…Œì´ì§• ë°°í¬ ì‹¤í–‰ ì¡°ê±´
on:
  push: # ì½”ë“œ í‘¸ì‹œ ì‹œ
    branches: [develop] # develop ë¸Œëœì¹˜ë§Œ
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  deploy-staging:
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½
    environment: staging # GitHub Environment 'staging' ì‚¬ìš© (ìŠ¹ì¸/ë³´ì•ˆ ì„¤ì • ê°€ëŠ¥)

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4 # ìµœì‹  ì²´í¬ì•„ì›ƒ ì•¡ì…˜

      # 2. Java ê°œë°œ í™˜ê²½ ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin' # Eclipse Temurin JDK
          java-version: '17' # Java 17

      # 3. ë°°í¬ ì „ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì•ˆì „ì„± í™•ë³´)
      - name: Run tests before deployment
        run: |
          chmod +x gradlew # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          ./gradlew test --no-daemon # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        env:
          JWT_SECRET_KEY: test-jwt-secret-key-for-ci-pipeline-must-be-256-bits # í…ŒìŠ¤íŠ¸ìš© JWT í‚¤

      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker Image
        run: |
          # ì»¤ë°‹ í•´ì‹œë¥¼ í¬í•¨í•œ íƒœê·¸ë¡œ ì´ë¯¸ì§€ ë¹Œë“œ
          docker build -t essay-backend:staging-${{ github.sha }} .
          # latest íƒœê·¸ë„ í•¨ê»˜ ìƒì„±
          docker tag essay-backend:staging-${{ github.sha }} essay-backend:staging-latest

      # 5. Docker ì´ë¯¸ì§€ë¥¼ íŒŒì¼ë¡œ ì €ì¥ (ì„œë²„ ì „ì†¡ìš©)
      - name: Save Docker Image
        run: docker save essay-backend:staging-latest | gzip > essay-backend-staging.tar.gz

      # 6. í•„ìš”í•œ íŒŒì¼ë“¤ì„ ìŠ¤í…Œì´ì§• ì„œë²„ë¡œ ë³µì‚¬
      - name: Copy files to staging server
        uses: appleboy/scp-action@v0.1.4 # SCP íŒŒì¼ ì „ì†¡ ì•¡ì…˜
        with:
          host: ${{ secrets.STAGING_HOST }} # ìŠ¤í…Œì´ì§• ì„œë²„ IP
          username: ${{ secrets.STAGING_USER }} # SSH ì‚¬ìš©ìëª…
          key: ${{ secrets.STAGING_SSH_KEY }} # SSH ê°œì¸í‚¤
          # ì „ì†¡í•  íŒŒì¼ë“¤: Docker ì´ë¯¸ì§€ + Docker Compose ì„¤ì • + ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸
          source: "essay-backend-staging.tar.gz,docker-compose.yml,init.sql"
          target: "/tmp/essay-staging/" # ì„œë²„ì˜ ëŒ€ìƒ ë””ë ‰í† ë¦¬

      # 7. ìŠ¤í…Œì´ì§• ì„œë²„ì— ë°°í¬ ì‹¤í–‰
      - name: Deploy to staging server
        uses: appleboy/ssh-action@v0.1.6 # SSH ëª…ë ¹ ì‹¤í–‰ ì•¡ì…˜
        with:
          host: ${{ secrets.STAGING_HOST }} # ìŠ¤í…Œì´ì§• ì„œë²„ IP
          username: ${{ secrets.STAGING_USER }} # SSH ì‚¬ìš©ìëª…
          key: ${{ secrets.STAGING_SSH_KEY }} # SSH ê°œì¸í‚¤
          script: | # ì„œë²„ì—ì„œ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸
            cd /tmp/essay-staging # ì‘ì—… ë””ë ‰í† ë¦¬ ì´ë™
            
            # ìƒˆë¡œìš´ Docker ì´ë¯¸ì§€ ë¡œë“œ
            docker load < essay-backend-staging.tar.gz
            
            # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            export SPRING_PROFILES_ACTIVE=dev # ê°œë°œ í”„ë¡œí•„ ì‚¬ìš©
            export DB_PASSWORD="${{ secrets.STAGING_DB_PASSWORD }}" # ìŠ¤í…Œì´ì§• DB ë¹„ë°€ë²ˆí˜¸
            export JWT_SECRET_KEY="${{ secrets.STAGING_JWT_SECRET }}" # ìŠ¤í…Œì´ì§• JWT í‚¤
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆë“¤ ì •ë¦¬ (--remove-orphansë¡œ ê³ ì•„ ì»¨í…Œì´ë„ˆë„ ì œê±°)
            docker-compose down --remove-orphans || true # ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
            
            # PostgreSQL ë¨¼ì € ì‹œì‘
            docker-compose up -d postgres
            
            # PostgreSQL ì¤€ë¹„ ëŒ€ê¸° (15ì´ˆ ê¸°ë³¸ ëŒ€ê¸° + ì¤€ë¹„ ìƒíƒœ í™•ì¸)
            sleep 15
            until docker exec essay-postgres pg_isready -U postgres; do
              echo "Waiting for PostgreSQL..." # PostgreSQL ì¤€ë¹„ ëŒ€ê¸° ë©”ì‹œì§€
              sleep 5 # 5ì´ˆë§ˆë‹¤ ì¬ì‹œë„
            done
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆ ì‹œì‘
            docker-compose up -d app
            
            # ì‹œìŠ¤í…œ ì •ë¦¬ (ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€/ì»¨í…Œì´ë„ˆ ì œê±°)
            docker system prune -f
            # ì „ì†¡ëœ ì´ë¯¸ì§€ íŒŒì¼ ì‚­ì œ
            rm -f essay-backend-staging.tar.gz

      # 8. ë°°í¬ í›„ í—¬ìŠ¤ì²´í¬ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
      - name: Health Check with retry
        run: |
          echo "Waiting for application to start..." # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸°
          sleep 30 # 30ì´ˆ ê¸°ë³¸ ëŒ€ê¸°
          
          # 10ë²ˆ ì‹œë„í•˜ì—¬ í—¬ìŠ¤ì²´í¬
          for i in {1..10}; do
            if curl -f -s ${{ secrets.STAGING_URL }}/api/health; then
              echo "âœ… Health check passed" # ì„±ê³µ ë©”ì‹œì§€
              exit 0 # ì„±ê³µ ì¢…ë£Œ
            fi
            echo "â³ Attempt $i/10 failed, retrying in 10 seconds..." # ì¬ì‹œë„ ë©”ì‹œì§€
            sleep 10 # 10ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„
          done
          
          echo "âŒ Health check failed after 10 attempts" # ì‹¤íŒ¨ ë©”ì‹œì§€
          exit 1 # ì‹¤íŒ¨ ì¢…ë£Œ

      # 9. ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ì²˜ë¦¬
      - name: Rollback on failure
        if: failure() # ì´ì „ ë‹¨ê³„ ì¤‘ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            echo "ğŸ”„ Rolling back due to deployment failure..." # ë¡¤ë°± ì‹œì‘ ë©”ì‹œì§€
            cd /tmp/essay-staging
            # ìµœê·¼ 50ì¤„ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
            docker-compose logs app --tail=50
            # ëª¨ë“  ì»¨í…Œì´ë„ˆ ì¤‘ë‹¨ (ì‹¤íŒ¨í•´ë„ ê³„ì†)
            docker-compose down || true

      # 10. ë°°í¬ ê²°ê³¼ ì•Œë¦¼
      - name: Notify deployment result
        if: always() # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        run: |
          # ì‘ì—… ìƒíƒœì— ë”°ë¥¸ ë©”ì‹œì§€ ì¶œë ¥
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ Staging deployment successful: ${{ github.sha }}" # ì„±ê³µ ë©”ì‹œì§€
          else
            echo "ğŸ’¥ Staging deployment failed: ${{ github.sha }}" # ì‹¤íŒ¨ ë©”ì‹œì§€
          fi